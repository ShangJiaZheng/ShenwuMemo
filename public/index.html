<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ç¥æ­¦æ”¶ç›Šè¿½è¸ªå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    
    <!-- cy227é¢„è§ˆç›¸å…³æ ·å¼ -->
    <style>
        .cy227-preview-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #3B82F6, #6366F1);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .cy227-preview-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .cy227-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1001;
        }
        .cy227-modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            margin: 2% auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        .cy227-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1002;
            background: rgba(0, 0, 0, 0.5);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cy227-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#6366F1',
                        text: {
                            primary: '#1E293B',
                            secondary: '#475569',
                            tertiary: '#64748B'
                        }
                    },
                    fontSize: {
                        'sm': '0.95rem',
                        'base': '1.1rem',
                        'lg': '1.25rem',
                        'xl': '1.35rem'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            /* éšè—å…¨å±€çºµå‘æ»šåŠ¨æ¡ï¼Œä½†ä¿æŒå†…å®¹å¯æ»šåŠ¨ */
            html {
                overflow-y: scroll;
                scrollbar-width: none; /* Firefox */
            }
            html::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Edge */
            }
            .text-shadow {
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .hover-btn {
                transition: all 0.2s ease;
            }
            .hover-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .bold-red {
                font-weight: bold;
                color: red;
            }
            .profit-highlight-week {
                background: linear-gradient(135deg, #10b981, #34d399);
                color: white;
                font-weight: bold;
                border-radius: 8px;
                padding: 2px 8px;
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
                animation: pulse-glow 2s infinite;
            }
            .profit-highlight-month {
                background: linear-gradient(135deg, #f59e0b, #fbbf24);
                color: white;
                font-weight: bold;
                border-radius: 4px;
                padding: 1px 4px;
                box-shadow: 0 1px 4px rgba(245, 158, 11, 0.4);
                animation: golden-glow 1.5s infinite alternate;
                font-size: 0.85em;
            }
            .profit-mostlight-month {
                background: linear-gradient(135deg,#ff0000, #ffabab);
                color: white;
                font-weight: bold;
                border-radius: 4px;
                padding: 1px 4px;
                box-shadow: 0 1px 4px rgba(245, 158, 11, 0.4);
                animation: golden-glow 1.5s infinite alternate;
                font-size: 0.85em;
            }
            @keyframes pulse-glow {
                0% { box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
                50% { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.6); }
                100% { box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
            }
            @keyframes golden-glow {
                0% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4); }
                100% { box-shadow: 0 6px 20px rgba(245, 158, 11, 0.8); }
            }
            .glass-card {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            /* Mac é€‚é…ä¼˜åŒ– */
            @media screen and (-webkit-min-device-pixel-ratio: 2) {
                body {
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                }
            }
            /* ç¡®ä¿è¡¨æ ¼åœ¨å°å±å¹•ä¸Šå¯ä»¥æ¨ªå‘æ»šåŠ¨ */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* ä¼˜åŒ–æ»šåŠ¨æ¡æ ·å¼ï¼ˆMacï¼‰ */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        }
    </style>
    <!-- å®šä¹‰å‘¨ä¸€åˆ°å‘¨æ—¥çš„é¢œè‰² -->
    <style>
        .week-day-1 {
            background-color: #EF4444;
            color: white;
        }

        .week-day-2 {
            background-color: #F59E0B;
            color: white;
        }

        .week-day-3 {
            background-color: #FBBF24;
            color: white;
        }

        .week-day-4 {
            background-color: #10B981;
            color: white;
        }

        .week-day-5 {
            background-color: #3B82F6;
            color: white;
        }

        .week-day-6 {
            background-color: #8B5CF6;
            color: white;
        }

        .week-day-7 {
            background-color: #8B5CF6;
            color: white;
        }
        .sparkline {
            display: block;
        }
        .sparkline polyline {
            stroke: #3b82f6;
            stroke-width: 1.5;
            fill: none;
        }
        /* ç­‰å®½æ•°å­—ï¼Œä¿è¯ 1 ä¸ 8 ç­‰å®½ */
        .tabular-nums {
            font-variant-numeric: tabular-nums;
            font-feature-settings: 'tnum' 1, 'lnum' 1;
        }
        .clickable-stat-container {
            position: relative;
            cursor: pointer;
        }
        .disabled-stat-container {
            position: relative;
            cursor: not-allowed;
        }
        .hover-pointer-icon,
        .hover-ban-icon {
            position: absolute;
            right: 6px;
            top: 6px;
            opacity: 0;
            transition: opacity .2s ease;
        }
        .clickable-stat-container:hover .hover-pointer-icon {
            opacity: 1;
        }
        .disabled-stat-container:hover .hover-ban-icon {
            opacity: 1;
        }
        .top-list {
            max-height: 320px;
            overflow-y: auto;
        }
        .top-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 10px;
            background: #f9fafb;
            margin-bottom: 8px;
        }
        .top-item:hover {
            background: #eef2ff;
        }
        .top-left {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .top-rank {
            width: 26px;
            height: 26px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            flex-shrink: 0;
        }
        .top-rank.r1 { background: linear-gradient(135deg,#f59e0b,#ef4444); }
        .top-rank.r2 { background: linear-gradient(135deg,#3b82f6,#8b5cf6); }
        .top-rank.r3 { background: linear-gradient(135deg,#10b981,#22c55e); }
        .top-rank.rx { background: #9ca3af; }
        .top-date { color: #374151; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .top-value { color: #111827; font-weight: 700; }
        .top-value { font-variant-numeric: tabular-nums; font-feature-settings: 'tnum' 1, 'lnum' 1; }
        #weekly-guard-list .guard-chip {
            display: inline-flex;
            align-items: center;
            background: #f3f4f6;
            color: #111827;
            padding: 6px 12px;
            border-radius: 9999px;
            margin-right: 6px;
            margin-bottom: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            font-size: 1rem;
            line-height: 1.25rem;
            cursor: pointer;
        }
        #weekly-guard-list .guard-chip:hover {
            background: #eef2ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
        }
        #weekly-guard-list .guard-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 8px;
        }
        .guard-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .guard-modal.show {
            display: flex;
        }
        .guard-modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .guard-modal-icon {
            width: 64px;
            height: 64px;
            object-fit: contain;
            margin: 0 auto 8px auto;
        }
        .guard-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        .guard-modal-dates {
            margin-top: 8px;
            font-size: 0.95rem;
            color: #4b5563;
        }
        .guard-modal-close {
            margin-top: 12px;
            background: #ef4444;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-gray-100 p-4 font-sans">
    <div class="max-w-full mx-auto px-2 sm:px-4 lg:px-6 flex flex-col min-h-[calc(100vh-2rem)]">
        <header class="gradient-bg rounded-lg shadow-md p-3 sm:p-4 mb-3 text-white">
            <h1 class="text-lg sm:text-xl font-bold text-center mb-0.5 text-shadow">ğŸ’° é˜³æ˜¥ç™½é›ª-ç‹å¯Œè´µ.</br>(3436055)</h1>
            <p class="text-center text-blue-100 text-xs sm:text-sm">è®°å½•æ¯ä¸€å¤©çš„å¢é•¿ï¼Œè§è¯è´¢å¯Œçš„ç§¯ç´¯</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼šä¸‰æ å¸ƒå±€ -->
        <div class="flex flex-col lg:flex-row gap-2 flex-1 min-h-0">
            <!-- ä¿å­˜æ•°æ®åŒºåŸŸï¼š15%å®½åº¦ -->
            <div class="w-full lg:w-[12%] xl:w-[15%] space-y-2 flex-shrink-0">
                <div class="bg-white rounded-lg shadow-sm p-3 h-[calc(100vh-200px)] flex flex-col overflow-hidden">
                    <!-- æ•°æ®å½•å…¥æ ‡é¢˜ -->
                    <h2
                        class="text-lg font-bold mb-3 text-text-primary flex items-center border-b border-gray-100 pb-2 flex-shrink-0">
                        <i class="fas fa-database mr-2 text-primary"></i>
                        æ•°æ®å½•å…¥
                    </h2>
                    <div class="flex-1 overflow-y-auto">
                    <form id="add-form" class="space-y-3">
                        <div class="form-group">
                            <label for="æ—¥æœŸ" class="block text-sm font-bold text-text-secondary mb-1">æ—¥æœŸ</label>
                            <div class="relative">
                                <input type="text" id="æ—¥æœŸ" name="æ—¥æœŸ"
                                    class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary cursor-pointer text-base"
                                    required readonly>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-calendar-alt text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="å‰©ä½™é“¶å¸" class="block text-sm font-bold text-text-secondary mb-0.5">å‰©ä½™é“¶å¸</label>
                            <input type="number" id="å‰©ä½™é“¶å¸" name="å‰©ä½™é“¶å¸"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="æ¶ˆè€—é“¶å¸" class="block text-sm font-bold text-text-secondary mb-0.5">æ¶ˆè€—é“¶å¸</label>
                            <input type="number" id="æ¶ˆè€—é“¶å¸" name="æ¶ˆè€—é“¶å¸"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-base">
                        </div>
                        <div class="form-group">
                            <label for="å›¾ç‰‡ä¸Šä¼ " class="block text-sm font-bold text-text-secondary mb-0.5">å›¾ç‰‡ä¸Šä¼ </label>
                            <!-- ç¾åŒ–åçš„å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="custom-file-upload"
                                class="w-full border-2 border-dashed border-gray-300 rounded-md p-3 text-center hover:border-primary transition-colors cursor-pointer bg-gray-50">
                                <input type="file" id="å›¾ç‰‡ä¸Šä¼ " name="å›¾ç‰‡ä¸Šä¼ " accept="image/*" multiple class="hidden">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-text-tertiary">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                                </div>
                            </div>
                            <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="file-info" class="mt-2 text-sm text-text-tertiary hidden"></div>
                        </div>
                        <button type="submit"
                            class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-1.5 px-3 rounded-md transition-colors text-base shadow hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-save mr-2"></i>
                            ä¿å­˜æ•°æ®
                        </button>
                        <!-- æ½œé¾™åœ¨æ¸ŠæŒ‰é’®ç§»åˆ°ä¿å­˜æ•°æ®ä¸‹æ–¹ -->
                        <button type="button" id="open-notes-btn"
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-bold py-1.5 px-3 rounded-md transition-colors text-base shadow hover:shadow-md transform hover:-translate-y-0.5">
                            <i class="fas fa-sticky-note mr-2"></i>
                            æ½œé¾™åœ¨æ¸Š
                        </button>
                    </form>
                    </div>
                </div>
            </div>

            <!-- æœ¬å‘¨æ•°æ®åŒºåŸŸï¼š35%å®½åº¦ -->
            <div class="w-full lg:w-[32%] xl:w-[35%] space-y-2 flex-shrink-0">
                <div class="bg-white rounded-lg shadow-sm p-3 h-[calc(100vh-200px)] flex flex-col overflow-hidden">
                    <!-- æœ¬å‘¨æ•°æ®æ ‡é¢˜ -->
                    <h2
                        class="text-lg font-bold mb-3 text-text-primary flex items-center border-b border-gray-100 pb-2 flex-shrink-0">
                        <i class="fas fa-calendar-week mr-2 text-primary"></i>
                        æœ¬å‘¨æ•°æ®
                    </h2>
                    <div class="mb-3 flex-shrink-0">
                        <div id="week-display"
                            class="text-sm xl:text-base text-primary font-bold text-center py-1 px-2 xl:px-3 bg-blue-50 rounded-md border border-blue-100 mt-0.5 transition-all duration-300 hover:bg-blue-100">
                            åŠ è½½ä¸­...</div>
                    </div>
                    <div class="flex-1 overflow-x-auto overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" style="min-width: 160px; max-width: 160px;"
                                        class="px-2 py-2 text-left text-xs xl:text-sm font-bold text-text-secondary uppercase tracking-wider whitespace-nowrap">
                                        æ—¥æœŸ
                                    </th>
                                    <th scope="col" style="min-width: 100px; max-width: 100px;"
                                        class="px-2 py-2 text-right text-xs xl:text-sm font-bold text-text-secondary uppercase tracking-wider whitespace-nowrap">
                                        å‰©ä½™
                                    </th>
                                    <th scope="col" style="min-width: 100px; max-width: 100px;"
                                        class="px-2 py-2 text-right text-xs xl:text-sm font-bold text-text-secondary uppercase tracking-wider whitespace-nowrap">
                                        æ¶ˆè€—
                                    </th>
                                    <th scope="col" style="min-width: 90px; max-width: 90px;"
                                        class="px-2 py-2 text-right text-xs xl:text-sm font-bold text-text-secondary uppercase tracking-wider whitespace-nowrap">
                                        æ”¶ç›Š
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- æ•°æ®å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                    <div id="weekly-guard-list" class="mt-2 mb-1 flex flex-wrap gap-2 items-center text-xs xl:text-sm text-text-primary"></div>
                    <div id="guard-detail-modal" class="guard-modal">
                        <div class="guard-modal-content">
                            <img id="guard-detail-icon" class="guard-modal-icon" src="" alt="">
                            <div id="guard-detail-text" class="guard-modal-title"></div>
                            <div id="guard-detail-dates" class="guard-modal-dates"></div>
                            <button id="guard-detail-close" class="guard-modal-close">å…³é—­</button>
                        </div>
                    </div>
                    <div id="profit-detail-modal" class="guard-modal">
                        <div class="guard-modal-content">
                            <div id="profit-detail-title" class="guard-modal-title"></div>
                            <div id="profit-detail-avg" class="guard-modal-dates"></div>
                            <div id="profit-detail-chart" class="mt-2"></div>
                            <button id="profit-detail-close" class="guard-modal-close">å…³é—­</button>
                        </div>
                    </div>
                    <div id="top-stats-modal" class="guard-modal">
                        <div class="guard-modal-content">
                            <div id="top-stats-title" class="guard-modal-title"></div>
                            <div id="top-stats-list" class="mt-2 text-sm text-gray-700 top-list"></div>
                            <button id="top-stats-close" class="guard-modal-close">å…³é—­</button>
                        </div>
                    </div>
                    
                    <div class="mt-2 pt-3 border-t border-gray-200 flex-shrink-0">
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2 cursor-pointer" ondblclick="toggleCheckbox('ä¿®ç‚¼ç“¶')" title="åŒå‡»åˆ‡æ¢çŠ¶æ€">
                                <span class="text-sm font-semibold text-text-primary">ä¿®ç‚¼ç“¶</span>
                                <span id="light-ä¿®ç‚¼ç“¶" class="inline-block w-4 h-4 rounded-full bg-red-500 relative">
                                    <span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span>
                                </span>
                            </div>
                            <div class="flex items-center gap-2 cursor-pointer" ondblclick="toggleCheckbox('ä¿å«é—¨æ´¾')" title="åŒå‡»åˆ‡æ¢çŠ¶æ€">
                                <span class="text-sm font-semibold text-text-primary">ä¿å«é—¨æ´¾</span>
                                <span id="light-ä¿å«é—¨æ´¾" class="inline-block w-4 h-4 rounded-full bg-red-500 relative">
                                    <span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span>
                                </span>
                                <input id="guard-content-input" type="text" placeholder="è¾“å…¥å†…å®¹" class="ml-3 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary w-32">
                                <button id="save-guard-content-btn" type="button" class="px-2 py-1 text-sm bg-primary text-white rounded-md hover:bg-primary/90">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸï¼šå ç”¨å‰©ä½™æ‰€æœ‰ç©ºé—´ -->
            <div class="w-full lg:flex-1 min-w-0">
                <div class="bg-white rounded-lg shadow-sm p-3 h-[calc(100vh-200px)] flex flex-col overflow-hidden">
                    <!-- ç»Ÿè®¡ä¿¡æ¯æ ‡é¢˜ -->
                    <h2
                        class="text-lg font-bold mb-3 text-text-primary flex items-center border-b border-gray-100 pb-2 flex-shrink-0">
                        <i class="fas fa-chart-pie mr-2 text-primary"></i>
                        ç»Ÿè®¡ä¿¡æ¯
                    </h2>
                    <div class="flex-1 overflow-y-auto">
                    <!-- è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯ä¸ºæ¯è¡Œæ˜¾ç¤º3ä¸ª -->
                    <div class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-3 gap-3">
                        <div
                            class="bg-gradient-to-br from-amber-500 to-amber-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-calendar-days text-lg xl:text-xl text-amber-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-amber-100 mb-0.5 text-center">è®°å½•å¤©æ•°</h3>
                                <div class="disabled-stat-container">
                                    <p id="record-days" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-ban hover-ban-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-blue-500 to-blue-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-coins text-lg xl:text-xl text-blue-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-blue-100 mb-0.5 text-center">æ€»æ”¶ç›Šé“¶å¸</h3>
                                <div class="disabled-stat-container">
                                    <p id="total-silver" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-ban hover-ban-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-green-500 to-green-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-fire text-lg xl:text-xl text-green-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-green-100 mb-0.5 text-center">æ€»æ¶ˆè€—é“¶å¸</h3>
                                <div class="disabled-stat-container">
                                    <p id="total-expense" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-ban hover-ban-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-purple-500 to-purple-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-trophy text-lg xl:text-xl text-red-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-red-100 mb-0.5 text-center">æ—¥æœ€é«˜æ”¶ç›Š</h3>
                                <div class="clickable-stat-container">
                                    <p id="max-daily-income" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-hand-pointer hover-pointer-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-red-500 to-pink-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-medal text-lg xl:text-xl text-orange-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-orange-100 mb-0.5 text-center">å‘¨æœ€é«˜æ”¶ç›Š</h3>
                                <div class="clickable-stat-container">
                                    <p id="max-weekly-income" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-hand-pointer hover-pointer-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-orange-500 to-yellow-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-crown text-lg xl:text-xl text-indigo-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-indigo-100 mb-0.5 text-center">æœˆæœ€é«˜æ”¶ç›Š</h3>
                                <div class="clickable-stat-container">
                                    <p id="max-monthly-income" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-hand-pointer hover-pointer-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-md text-white shadow-sm hover:shadow-md transition-all-300 hover:scale-101 transform flex flex-col sm:flex-row items-center gap-2">
                            <i class="fas fa-chart-pie text-lg xl:text-xl text-purple-200 opacity-80"></i>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-xs xl:text-sm font-bold text-purple-100 mb-0.5 text-center">æ—¥å¹³å‡æ”¶ç›Š</h3>
                                <div class="disabled-stat-container">
                                    <p id="average-daily-income" class="text-base xl:text-lg font-bold text-center truncate tabular-nums">0</p>
                                    <i class="fas fa-ban hover-ban-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ”¶å…¥æ¶ˆè€—å˜åŒ–å›¾è¡¨ -->
                    <div class="mt-3 p-2 border border-gray-200 rounded-lg bg-white">
                        <h3 class="text-sm xl:text-base font-bold mb-2 text-text-primary flex items-center">
                            <i class="fas fa-chart-line mr-2 text-primary"></i>
                            æ”¶å…¥æ¶ˆè€—å˜åŒ–
                        </h3>
                        <div class="h-48 xl:h-64">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¾åŒ–å›¾ç‰‡ä¸Šä¼ åŒºåŸŸçš„JS -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const customFileUpload = document.getElementById('custom-file-upload');
                const fileInput = document.getElementById('å›¾ç‰‡ä¸Šä¼ ');
                const fileInfo = document.getElementById('file-info');

                // ç‚¹å‡»è‡ªå®šä¹‰ä¸Šä¼ åŒºåŸŸæ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
                customFileUpload.addEventListener('click', function () {
                    fileInput.click();
                });

                // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        fileInfo.textContent = `å·²é€‰æ‹© ${this.files.length} ä¸ªæ–‡ä»¶`;
                        fileInfo.classList.remove('hidden');
                        // ä¸ºä¸Šä¼ åŒºåŸŸæ·»åŠ é€‰ä¸­æ•ˆæœ
                        customFileUpload.classList.add('border-primary', 'bg-blue-50');
                        setTimeout(() => {
                            customFileUpload.classList.remove('border-primary', 'bg-blue-50');
                        }, 1500);
                    } else {
                        fileInfo.classList.add('hidden');
                    }
                });

                // æ·»åŠ æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    customFileUpload.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    customFileUpload.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    customFileUpload.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    customFileUpload.classList.add('border-primary', 'bg-blue-50');
                }

                function unhighlight() {
                    customFileUpload.classList.remove('border-primary', 'bg-blue-50');
                }

                customFileUpload.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length > 0) {
                        // åˆ›å»ºä¸€ä¸ªæ–°çš„FileListå¯¹è±¡
                        const dataTransfer = new DataTransfer();
                        for (let i = 0; i < files.length; i++) {
                            if (files[i].type.startsWith('image/')) {
                                dataTransfer.items.add(files[i]);
                            }
                        }

                        if (dataTransfer.files.length > 0) {
                            fileInput.files = dataTransfer.files;
                            fileInfo.textContent = `å·²é€‰æ‹© ${dataTransfer.files.length} ä¸ªå›¾ç‰‡æ–‡ä»¶`;
                            fileInfo.classList.remove('hidden');
                        }
                    }
                }
            });
        </script>

        <!-- å­ç”»é¢ï¼ˆå¤‡æ³¨ç®¡ç†æ¨¡æ€æ¡†ï¼‰ -->
        <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 max-w-2xl max-h-[90vh] overflow-auto w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-sticky-note text-primary mr-2"></i>
                        æ½œé¾™åœ¨æ¸Šè¯¦æƒ…
                    </h3>
                    <button id="close-notes-btn" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-2 mb-6">
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note1"></div>
                        <input type="text" id="note1" name="note1"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note1"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note2"></div>
                        <input type="text" id="note2" name="note2"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note2"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note3"></div>
                        <input type="text" id="note3" name="note3"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note3"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note4"></div>
                        <input type="text" id="note4" name="note4"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note4"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note5"></div>
                        <input type="text" id="note5" name="note5"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note5"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note6"></div>
                        <input type="text" id="note6" name="note6"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note6"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="form-group flex gap-4 items-center mb-4 h-[50px]">
                        <div class="pet-avatar w-[50px] h-full flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 shadow-sm flex items-center justify-center" id="avatar-note7"></div>
                        <input type="text" id="note7" name="note7"
                            class="flex-1 h-full px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <div id="preview-note7"
                            class="w-1/2 p-3 bg-gray-50 rounded-lg border border-gray-200 h-full overflow-auto flex items-center"
                            style="display: none;"></div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button id="undo-notes-btn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-md flex items-center gap-2 hidden">
                            <i class="fas fa-undo"></i>
                            æ’¤å›
                        </button>
                        <button id="save-notes-btn"
                            class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-md flex items-center gap-2">
                            <i class="fas fa-save"></i>
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆè€—é“¶å¸è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="expense-details-modal"
            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-coins text-yellow-500 mr-2"></i>
                        æ¶ˆè€—è¯¦æƒ…
                    </h3>
                    <button id="close-expense-details-btn" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="form-group">
                        <label for="expense-date" class="block text-sm font-bold text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="text" id="expense-date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" readonly>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount" class="block text-sm font-bold text-gray-700 mb-1">æ¶ˆè€—é“¶å¸</label>
                        <input type="text" id="expense-amount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" readonly>
                    </div>
                    <div class="form-group">
                        <label for="expense-details" class="block text-sm font-bold text-gray-700 mb-1">æ¶ˆè€—è¯¦æƒ…</label>
                        <textarea id="expense-details" rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button id="undo-expense-details-btn"
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-md flex items-center gap-2 hidden">
                        <i class="fas fa-undo"></i>
                        æ’¤å›
                    </button>
                    <button id="save-expense-details-btn"
                        class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow hover:shadow-md flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
        <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-4 max-w-4xl max-h-[80vh] overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">å›¾ç‰‡æŸ¥çœ‹</h3>
                    <button onclick="closeImages()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="image-gallery" class="grid grid-cols-3 gap-2">
                    <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <script>
            // åˆå§‹åŒ–flatpickræ—¥æœŸé€‰æ‹©å™¨
            const datePicker = flatpickr("#æ—¥æœŸ", {
                locale: "zh",
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                maxDate: new Date(),
                allowInput: false,
                clickOpens: true,
                theme: "material_blue"
            });

            // åŠ è½½æŒ‡å®šæ—¥æœŸçš„æ•°æ®
            async function loadDailyData(date) {
                try {
                    const response = await fetch(`/get_daily_data?date=${date}`);
                    const data = await response.json();

                    if (data.exists) {
                        // å¦‚æœå½“å¤©æœ‰è®°å½•ï¼Œå¡«å……è¡¨å•
                        document.getElementById('å‰©ä½™é“¶å¸').value = data.å‰©ä½™é“¶å¸ || 0;
                        document.getElementById('æ¶ˆè€—é“¶å¸').value = data.æ¶ˆè€—é“¶å¸ || 0;
                    } else {
                        // å¦‚æœå½“å¤©æ²¡æœ‰è®°å½•ï¼Œæ¸…ç©ºè¡¨å•
                        document.getElementById('å‰©ä½™é“¶å¸').value = '';
                        document.getElementById('æ¶ˆè€—é“¶å¸').value = '';
                    }
                } catch (error) {
                    console.error('åŠ è½½å½“å¤©æ•°æ®å¤±è´¥:', error);
                }
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function () {
                const today = datePicker.formatDate(new Date(), "Y-m-d");
                loadDailyData(today);
                loadDataTable();
                loadWeeklyGuardInputs();
                loadCheckboxes(today);
                // åˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°å¯ç¼–è¾‘çŠ¶æ€
                setTimeout(() => {
                    updateCheckboxEditable(today);
                }, 100);
            });

            // ç›‘å¬æ—¥æœŸå˜åŒ–äº‹ä»¶
            datePicker.config.onChange.push(function (selectedDates, dateStr) {
                loadDailyData(dateStr);
                loadCheckboxes(dateStr);
            });

            // å­˜å‚¨checkboxçŠ¶æ€
            let checkboxStates = {
                ä¿®ç‚¼ç“¶: false,
                ä¿å«é—¨æ´¾: false
            };
            
            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯ä»Šå¤©
            function isToday(dateStr) {
                const today = new Date();
                const selectedDate = new Date(dateStr);
                return today.toDateString() === selectedDate.toDateString();
            }

            // åŠ è½½checkboxçŠ¶æ€
            async function loadCheckboxes(date) {
                try {
                    const response = await fetch(`/get_checkboxes?date=${date}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        // å¦‚æœå½“å¤©æœ‰è®°å½•ï¼Œè®¾ç½®çŠ¶æ€
                        checkboxStates.ä¿®ç‚¼ç“¶ = data.ä¿®ç‚¼ç“¶ === 'true' || data.ä¿®ç‚¼ç“¶ === true;
                        checkboxStates.ä¿å«é—¨æ´¾ = data.ä¿å«é—¨æ´¾ === 'true' || data.ä¿å«é—¨æ´¾ === true;
                    } else {
                        // å¦‚æœå½“å¤©æ²¡æœ‰è®°å½•ï¼Œé‡ç½®çŠ¶æ€
                        checkboxStates.ä¿®ç‚¼ç“¶ = false;
                        checkboxStates.ä¿å«é—¨æ´¾ = false;
                    }
                    
                    // æ›´æ–°çº¢ç»¿ç¯æ˜¾ç¤ºå’Œå¯ç¼–è¾‘çŠ¶æ€
                    updateCheckboxLights();
                    updateCheckboxEditable(date);
                } catch (error) {
                    console.error('åŠ è½½checkboxçŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // æ›´æ–°checkboxçš„å¯ç¼–è¾‘çŠ¶æ€
            function updateCheckboxEditable(date) {
                const ä¿®ç‚¼ç“¶Div = document.querySelector('[ondblclick="toggleCheckbox(\'ä¿®ç‚¼ç“¶\')"]');
                const ä¿å«é—¨æ´¾Div = document.querySelector('[ondblclick="toggleCheckbox(\'ä¿å«é—¨æ´¾\')"]');
                
                const canEdit = isToday(date);
                
                if (canEdit) {
                    // å¯ä»¥ç¼–è¾‘
                    if (ä¿®ç‚¼ç“¶Div) {
                        ä¿®ç‚¼ç“¶Div.style.cursor = 'pointer';
                        ä¿®ç‚¼ç“¶Div.style.opacity = '1';
                    }
                    if (ä¿å«é—¨æ´¾Div) {
                        ä¿å«é—¨æ´¾Div.style.cursor = 'pointer';
                        ä¿å«é—¨æ´¾Div.style.opacity = '1';
                    }
                } else {
                    // ä¸å¯ç¼–è¾‘
                    if (ä¿®ç‚¼ç“¶Div) {
                        ä¿®ç‚¼ç“¶Div.style.cursor = 'not-allowed';
                        ä¿®ç‚¼ç“¶Div.style.opacity = '0.6';
                    }
                    if (ä¿å«é—¨æ´¾Div) {
                        ä¿å«é—¨æ´¾Div.style.cursor = 'not-allowed';
                        ä¿å«é—¨æ´¾Div.style.opacity = '0.6';
                    }
                }
            }

            // æ›´æ–°çº¢ç»¿ç¯æ˜¾ç¤º
            function updateCheckboxLights() {
                const ä¿®ç‚¼ç“¶Light = document.getElementById('light-ä¿®ç‚¼ç“¶');
                const ä¿å«é—¨æ´¾Light = document.getElementById('light-ä¿å«é—¨æ´¾');
                
                // ä¿®ç‚¼ç“¶
                if (checkboxStates.ä¿®ç‚¼ç“¶) {
                    ä¿®ç‚¼ç“¶Light.className = 'inline-block w-4 h-4 rounded-full bg-green-500 relative';
                    ä¿®ç‚¼ç“¶Light.innerHTML = '<span class="absolute inset-0 rounded-full bg-green-400 blur-sm opacity-70"></span>';
                } else {
                    ä¿®ç‚¼ç“¶Light.className = 'inline-block w-4 h-4 rounded-full bg-red-500 relative';
                    ä¿®ç‚¼ç“¶Light.innerHTML = '<span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span>';
                }
                
                // ä¿å«é—¨æ´¾
                if (checkboxStates.ä¿å«é—¨æ´¾) {
                    ä¿å«é—¨æ´¾Light.className = 'inline-block w-4 h-4 rounded-full bg-green-500 relative';
                    ä¿å«é—¨æ´¾Light.innerHTML = '<span class="absolute inset-0 rounded-full bg-green-400 blur-sm opacity-70"></span>';
                } else {
                    ä¿å«é—¨æ´¾Light.className = 'inline-block w-4 h-4 rounded-full bg-red-500 relative';
                    ä¿å«é—¨æ´¾Light.innerHTML = '<span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span>';
                }
            }

            // åˆ‡æ¢checkboxçŠ¶æ€å¹¶è‡ªåŠ¨ä¿å­˜
            async function toggleCheckbox(name) {
                const date = document.getElementById('æ—¥æœŸ').value;
                
                if (!date) {
                    showToast('è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©ï¼Œåªæœ‰ä»Šå¤©å¯ä»¥ç¼–è¾‘
                if (!isToday(date)) {
                    showToast('åªèƒ½ç¼–è¾‘å½“å¤©çš„çŠ¶æ€', 'error');
                    return;
                }
                
                // åˆ‡æ¢çŠ¶æ€
                checkboxStates[name] = !checkboxStates[name];
                
                // æ›´æ–°æ˜¾ç¤º
                updateCheckboxLights();
                
                // è‡ªåŠ¨ä¿å­˜
                try {
                    const response = await fetch('/save_checkboxes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            date, 
                            ä¿®ç‚¼ç“¶: checkboxStates.ä¿®ç‚¼ç“¶.toString(),
                            ä¿å«é—¨æ´¾: checkboxStates.ä¿å«é—¨æ´¾.toString()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showToast('ä¿å­˜æˆåŠŸ');
                    } else {
                        showToast('ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                        // æ¢å¤çŠ¶æ€
                        checkboxStates[name] = !checkboxStates[name];
                        updateCheckboxLights();
                    }
                } catch (error) {
                    console.error('ä¿å­˜checkboxçŠ¶æ€å¤±è´¥:', error);
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    // æ¢å¤çŠ¶æ€
                    checkboxStates[name] = !checkboxStates[name];
                    updateCheckboxLights();
                }
            }

            // æ£€æŸ¥æŒ‡å®šæ—¥æœŸæ˜¯å¦æœ‰å›¾ç‰‡
            async function checkDailyImages(date) {
                try {
                    const response = await fetch(`/get_images?date=${date}`);
                    const data = await response.json();
                    const images = Array.isArray(data) ? data : data.files || [];
                    return images.length > 0;
                } catch (error) {
                    console.error('æ£€æŸ¥å›¾ç‰‡å¤±è´¥:', error);
                    return false;
                }
            }

            let currentWeekOffset = 0; // å½“å‰æŸ¥çœ‹çš„å‘¨åç§»é‡ï¼Œ0è¡¨ç¤ºæœ¬å‘¨ï¼Œ-1è¡¨ç¤ºä¸Šå‘¨ï¼Œ1è¡¨ç¤ºä¸‹å‘¨

            // åŠ è½½æ•°æ®è¡¨æ ¼
            async function loadDataTable() {
                try {
                    const response = await fetch('/data');
                    const data = await response.json();

                    // ä½¿ç”¨å…¼å®¹çš„æ•°æ®å­—æ®µå
                    const records = data.records || data.data || [];

                    // è·å–æŒ‡å®šå‘¨çš„èµ·å§‹å’Œç»“æŸæ—¥æœŸ
                    function getWeekRange(weekOffset) {
                        const today = new Date();
                        const currentDay = today.getDay();
                        const diff = currentDay === 0 ? -6 : 1 - currentDay; // è°ƒæ•´åˆ°æœ¬å‘¨ä¸€

                        const monday = new Date(today);
                        monday.setDate(today.getDate() + diff + (weekOffset * 7));
                        monday.setHours(0, 0, 0, 0);

                        const sunday = new Date(monday);
                        sunday.setDate(monday.getDate() + 6);
                        sunday.setHours(23, 59, 59, 999);

                        return { start: monday, end: sunday };
                    }

                    const weekRange = getWeekRange(currentWeekOffset);

                    // è¿‡æ»¤æŒ‡å®šå‘¨çš„æ•°æ®
                    const currentWeekData = records.filter(record => {
                        const recordDate = new Date(record.æ—¥æœŸ);
                        return recordDate >= weekRange.start && recordDate <= weekRange.end;
                    }).sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ));

                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆæŒ‰æ–°è¦æ±‚è®¡ç®—ï¼‰
                    // æ€»æ”¶ç›Šé“¶å¸ï¼šæœ€æ–°ä¸€å¤©çš„å‰©ä½™é“¶å¸åŠ ä¸Šæ€»æ¶ˆè€—é“¶å¸
                    const sortedRecords = [...records].sort((a, b) => new Date(b.æ—¥æœŸ) - new Date(a.æ—¥æœŸ));
                    const latestSilver = sortedRecords.length > 0 ? parseFloat(sortedRecords[0].å‰©ä½™é“¶å¸) || 0 : 0;
                    const totalExpense = records.reduce((sum, record) => sum + (parseFloat(record.æ¶ˆè€—é“¶å¸) || 0), 0);
                    const totalProfitSilver = latestSilver + totalExpense;

                    // æ—¥å¹³å‡æ”¶ç›Šï¼šæ¯å¤©æ”¶ç›Šçš„æ€»å’Œé™¤ä»¥è®°å½•å¤©æ•°
                    const dailyProfits = records.map(record => parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0);
                    const totalProfit = dailyProfits.reduce((sum, profit) => sum + profit, 0);
                    const recordDays = records.length;
                    const averageDaily = recordDays > 0 ? Math.round(totalProfit / recordDays) : 0;

                    // æ—¥æœ€é«˜æ”¶ç›Šï¼šæ‰€æœ‰è®°å½•ä¸­çš„æœ€å¤§æ”¶ç›Š
                    const maxDailyIncome = dailyProfits.length > 0 ? Math.max(...dailyProfits) : 0;

                    // è®¡ç®—å‘¨æœ€é«˜æ”¶ç›Š
                    function calculateWeeklyMax(records) {
                        const weeklyData = {};
                        records.forEach(record => {
                            const date = new Date(record.æ—¥æœŸ);
                            const year = date.getFullYear();
                            const week = getWeekNumber(date);
                            const key = `${year}-W${week}`;
                            const profit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;

                            if (!weeklyData[key]) {
                                weeklyData[key] = 0;
                            }
                            weeklyData[key] += profit;
                        });

                        const weeklyProfits = Object.values(weeklyData);
                        return weeklyProfits.length > 0 ? Math.max(...weeklyProfits) : 0;
                    }

                    // è®¡ç®—æœˆæœ€é«˜æ”¶ç›Š
                    function calculateMonthlyMax(records) {
                        const monthlyData = {};
                        records.forEach(record => {
                            const date = new Date(record.æ—¥æœŸ);
                            const year = date.getFullYear();
                            const month = date.getMonth() + 1;
                            const key = `${year}-${month.toString().padStart(2, '0')}`;
                            const profit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;

                            if (!monthlyData[key]) {
                                monthlyData[key] = 0;
                            }
                            monthlyData[key] += profit;
                        });

                        const monthlyProfits = Object.values(monthlyData);
                        return monthlyProfits.length > 0 ? Math.max(...monthlyProfits) : 0;
                    }

                    // è·å–ISOå‘¨æ•°
                    function getWeekNumber(date) {
                        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                        const dayNum = d.getUTCDay() || 7;
                        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                    }

                    const maxWeeklyIncome = calculateWeeklyMax(records);
                    const maxMonthlyIncome = calculateMonthlyMax(records);

                    document.getElementById('total-silver').textContent = totalProfitSilver.toLocaleString();
                    document.getElementById('total-expense').textContent = totalExpense.toLocaleString();
                    document.getElementById('average-daily-income').textContent = averageDaily.toLocaleString();
                    document.getElementById('record-days').textContent = recordDays.toLocaleString();
                    document.getElementById('max-daily-income').textContent = maxDailyIncome.toLocaleString();
                    document.getElementById('max-weekly-income').textContent = maxWeeklyIncome.toLocaleString();
                    document.getElementById('max-monthly-income').textContent = maxMonthlyIncome.toLocaleString();

                    // å¡«å……æ•°æ®è¡¨æ ¼
                    const tbody = document.getElementById('data-table-body');
                    tbody.innerHTML = '';

                    // è®¡ç®—æœˆå¹³å‡
                    const monthAvg = calculateMonthlyAverage(records);

                    // é¢„åŠ è½½æœ‰æ¶ˆè€—è¯¦æƒ…çš„æ—¥æœŸ
                    await loadDatesWithExpenseDetails();
                    
                    // ä½¿ç”¨Promise.allå¹¶è¡Œæ£€æŸ¥æ‰€æœ‰æ—¥æœŸçš„å›¾ç‰‡
                    const imageChecks = await Promise.all(
                        currentWeekData.map(record => checkDailyImages(record.æ—¥æœŸ))
                    );

                    // è®¡ç®—æ¯ä¸ªæ˜ŸæœŸå‡ çš„å¹³å‡æ”¶å…¥
                    function calculateWeekdayAverage(records) {
                        const weekdayData = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: []}; // 1=å‘¨ä¸€, 7=å‘¨æ—¥
                        const weekdayAverage = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};

                        records.forEach(record => {
                            const date = new Date(record.æ—¥æœŸ);
                            const dayOfWeek = date.getDay() || 7; // 0æ˜¯å‘¨æ—¥ï¼Œè½¬ä¸º7
                            const profit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;
                            if (profit > 0) { // åªè€ƒè™‘æœ‰æ”¶ç›Šçš„è®°å½•
                                weekdayData[dayOfWeek].push(profit);
                            }
                        });

                        // è®¡ç®—å¹³å‡å€¼
                        for (let day = 1; day <= 7; day++) {
                            const profits = weekdayData[day];
                            if (profits.length > 0) {
                                const sum = profits.reduce((acc, val) => acc + val, 0);
                                weekdayAverage[day] = Math.round(sum / profits.length);
                            }
                        }

                        return weekdayAverage;
                    }

                    const weekdayAverages = calculateWeekdayAverage(records);

                    function getMonthWeekdaySeries(records, targetDate) {
                        const d = new Date(targetDate);
                        const y = d.getFullYear();
                        const m = d.getMonth();
                        const w = d.getDay() || 7;
                        const series = [];
                        records.forEach(r => {
                            const rd = new Date(r.æ—¥æœŸ);
                            if (rd.getFullYear() === y && rd.getMonth() === m && (rd.getDay() || 7) === w) {
                                const val = parseFloat(r.ä»Šæ—¥æ”¶ç›Š) || 0;
                                if (val > 0) series.push({ date: rd, value: val });
                            }
                        });
                        series.sort((a,b) => a.date - b.date);
                        return series.map(s => s.value);
                    }

                    function getSeriesAverage(series) {
                        if (!series || series.length === 0) return 0;
                        const sum = series.reduce((acc, v) => acc + v, 0);
                        return Math.round(sum / series.length);
                    }

                    function renderSparkline(series, width = 80, height = 24) {
                        if (!series || series.length === 0) {
                            return `<svg class="sparkline" width="${width}" height="${height}"></svg>`;
                        }
                        const min = Math.min(...series);
                        const max = Math.max(...series);
                        const n = series.length;
                        const stepX = width / Math.max(1, n - 1);
                        const scaleY = max === min ? 1 : (height - 4) / (max - min);
                        const points = series.map((v, i) => {
                            const x = Math.round(i * stepX);
                            const y = Math.round(height - 2 - (v - min) * scaleY);
                            return `${x},${y}`;
                        }).join(' ');
                        return `<svg class="sparkline" width="${width}" height="${height}"><polyline points="${points}"/></svg>`;
                    }

                    currentWeekData.forEach((record, index) => {
                        const tr = document.createElement('tr');
                        const date = new Date(record.æ—¥æœŸ);
                        const dayOfWeek = date.getDay() || 7; // 0æ˜¯å‘¨æ—¥ï¼Œè½¬ä¸º7

                        const hasImages = imageChecks[index];
                        const imageButton = hasImages ?
                            `<button onclick="showImages('${record.æ—¥æœŸ}')" class="text-blue-500 hover:text-blue-700 hover:scale-110 transition-transform text-sm">
                            <i class="fas fa-image"></i>
                        </button>` : '';

                        // è®¡ç®—æ”¶ç›Šå¯¹æ¯”æ•ˆæœ - å¢å¼ºå¤„ç†é€»è¾‘ï¼Œç¡®ä¿ç©ºå€¼æ—¶æ˜¾ç¤º0
                        const todayProfit = typeof record.ä»Šæ—¥æ”¶ç›Š === 'undefined' || record.ä»Šæ—¥æ”¶ç›Š === null || record.ä»Šæ—¥æ”¶ç›Š === '' ? 0 : parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;
                        
                        // åˆ¤æ–­æ˜¯å¦æœ‰æ¶ˆè€—è¯¦æƒ…
                        const hasDetail = hasExpenseDetails(record.æ—¥æœŸ);
                        const detailIcon = hasDetail ? 
                            `<i class="fas fa-comment text-gray-500 mr-1"></i>` : '';
                        
                        // æ¯”è¾ƒå½“å¤©æ”¶ç›Šä¸è¯¥æ˜ŸæœŸå‡ çš„å¹³å‡æ”¶å…¥
                        const weekdayAverage = weekdayAverages[dayOfWeek];
                        let trendIcon = '';
                        if (todayProfit > 0) { // åªå¯¹æœ‰æ”¶ç›Šçš„è®°å½•æ˜¾ç¤ºè¶‹åŠ¿å›¾æ ‡
                            if (weekdayAverage > 0) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®
                                const weekdayText = 'ä¸€äºŒä¸‰å››äº”å…­æ—¥'[dayOfWeek - 1];
                                if (todayProfit > weekdayAverage) {
                                    trendIcon = `<i class="fas fa-arrow-trend-up mr-1 animate-pulse"></i>`;
                                } else if (todayProfit < weekdayAverage) {
                                    trendIcon = `<i class="fas fa-arrow-trend-down mr-1 animate-pulse"></i>`;
                                } else {
                                    trendIcon = `<i class="fas fa-minus mr-1"></i>`;
                                }
                            }
                        }

                        const monthSeries = getMonthWeekdaySeries(records, record.æ—¥æœŸ);
                        const monthAvgSameWeek = getSeriesAverage(monthSeries);
                        const sparklineStr = renderSparkline(monthSeries);

                        tr.className = 'hover:bg-gray-50 transition-colors';
                        tr.innerHTML = `
                        <td style="min-width: 160px; max-width: 160px;" class="px-1 py-1.5 text-xs xl:text-sm font-bold text-gray-900 cursor-pointer hover:bg-gray-100 transition-colors border border-dashed border-gray-200" ondblclick="jumpToDate('${record.æ—¥æœŸ}')">
                            <div class="flex items-center justify-between gap-1">
                                <div class="flex items-center flex-wrap gap-1">
                                    <span class="week-day-${dayOfWeek} px-1 py-0.5 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">
                                        å‘¨${'ä¸€äºŒä¸‰å››äº”å…­æ—¥'[dayOfWeek - 1]}
                                    </span>
                                    <span class="text-gray-900 font-semibold text-xs xl:text-sm whitespace-nowrap">${record.æ—¥æœŸ}</span>
                                </div>
                                <span class="flex-shrink-0">${imageButton}</span>
                            </div>
                        </td>
                        <td style="min-width: 100px; max-width: 100px;" class="px-1 py-1.5 text-xs xl:text-sm font-bold ${getAmountClass(parseFloat(record.å‰©ä½™é“¶å¸ || 0), 'remaining')} text-right border border-dashed border-gray-200">
                            <span class="whitespace-nowrap tabular-nums">${record.å‰©ä½™é“¶å¸.toLocaleString()}</span>
                        </td>
                        <td style="min-width: 100px; max-width: 100px; cursor: pointer;" class="px-1 py-1.5 text-xs xl:text-sm font-bold ${getAmountClass(parseFloat(record.æ¶ˆè€—é“¶å¸ || 0), 'expense')} border border-dashed border-gray-200" ondblclick="openExpenseDetails('${record.æ—¥æœŸ}', ${record.æ¶ˆè€—é“¶å¸ || 0})">
                            <div class="flex items-center justify-between">
                                <span class="flex-shrink-0">${detailIcon || '<i class="fas fa-coins text-gray-400"></i>'}</span>
                                <span class="whitespace-nowrap text-right tabular-nums">${record.æ¶ˆè€—é“¶å¸ || 0}</span>
                            </div>
                        </td>
                        <td style="min-width: 90px; max-width: 90px;" class="px-1 py-1.5 text-xs xl:text-sm font-bold border border-dashed border-gray-200" onclick="openProfitDetail('${record.æ—¥æœŸ}')">
                            <div class="flex items-center justify-between ${getAmountClass(todayProfit, 'profit-container')} rounded px-1">
                                <span class="flex-shrink-0">${trendIcon || '<i class="fas fa-chart-line"></i>'}</span>
                                <span class="whitespace-nowrap text-right tabular-nums">${(!isNaN(todayProfit) ? todayProfit : "0").toLocaleString()}</span>
                            </div>
                        </td>

                    `;
                        tbody.appendChild(tr);
                    });

                    // æ˜¾ç¤ºå½“å‰å‘¨èŒƒå›´å’Œç¿»é¡µæ§åˆ¶
                    const weekDisplay = document.getElementById('week-display');
                    const weekText = getWeekText(currentWeekOffset);
                    const weekRecords = getWeekRecords(records, currentWeekOffset);
                    const weeklyIncome = calculateWeeklyIncome(weekRecords);

                    // æ£€æŸ¥ä¸Šä¸€å‘¨å’Œä¸‹ä¸€å‘¨æ˜¯å¦æœ‰æ•°æ®
                    const prevWeekRecords = getWeekRecords(records, currentWeekOffset - 1);
                    const nextWeekRecords = getWeekRecords(records, currentWeekOffset + 1);

                    const prevDisabled = prevWeekRecords.length === 0;
                    const nextDisabled = nextWeekRecords.length === 0;

                    if (!weekDisplay) {
                        const header = document.querySelector('#data-table').parentElement.querySelector('h2');
                        const weekInfo = document.createElement('div');
                        weekInfo.id = 'week-display';
                        weekInfo.className = 'flex justify-between items-center text-sm';
                        weekInfo.innerHTML = `
                        <div class="text-gray-600">${weekText}</div>
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center space-x-2">
                                <div class="text-base font-bold bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                                    ğŸ’° ${weeklyIncome.toLocaleString()}
                                </div>
                                <div class="text-base font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                                    ğŸ“Š ${calculateWeeklyTotal(weekRecords).toLocaleString()}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="changeWeek(-1)" class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors ${prevDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${prevDisabled ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-left mr-1"></i>
                                </button>
                                <button onclick="changeWeek(0)" class="px-4 py-2 text-sm bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                    <i class="fas fa-home mr-1"></i>
                                </button>
                                <button onclick="changeWeek(1)" class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors ${nextDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    `;
                        header.parentElement.insertBefore(weekInfo, header.nextSibling);
                    } else {
                        weekDisplay.innerHTML = `
                        <div class="text-gray-600">${weekText}</div>
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center space-x-2">
                                <div class="text-base font-bold bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                                    ğŸ’° ${weeklyIncome.toLocaleString()}
                                </div>
                                <div class="text-base font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                                    ğŸ“Š ${calculateWeeklyTotal(weekRecords).toLocaleString()}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="changeWeek(-1)" class="px-4 py-2 text-base bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors ${prevDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${prevDisabled ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-left mr-1"></i>
                                </button>
                                <button onclick="changeWeek(0)" class="px-4 py-2 text-base bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                    <i class="fas fa-home mr-1"></i>
                                </button>
                                <button onclick="changeWeek(1)" class="px-4 py-2 text-base bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors ${nextDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''}>
                                    <i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®è¡¨æ ¼å¤±è´¥:', error);
                }
            }

            // è·å–å‘¨çš„æ–‡æœ¬æè¿°
            function getWeekText(weekOffset) {
                const today = new Date();
                const currentDay = today.getDay();
                const diff = currentDay === 0 ? -6 : 1 - currentDay;

                const monday = new Date(today);
                monday.setDate(today.getDate() + diff + (weekOffset * 7));
                monday.setHours(0, 0, 0, 0);

                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);

                if (weekOffset === 0) {
                    return `æœ¬å‘¨ï¼š${monday.toLocaleDateString('zh-CN')} - ${sunday.toLocaleDateString('zh-CN')}`;
                } else if (weekOffset === -1) {
                    return `ä¸Šå‘¨ï¼š${monday.toLocaleDateString('zh-CN')} - ${sunday.toLocaleDateString('zh-CN')}`;
                } else if (weekOffset === 1) {
                    return `ä¸‹å‘¨ï¼š${monday.toLocaleDateString('zh-CN')} - ${sunday.toLocaleDateString('zh-CN')}`;
                } else if (weekOffset < 0) {
                    return `${Math.abs(weekOffset)}å‘¨å‰ï¼š${monday.toLocaleDateString('zh-CN')} - ${sunday.toLocaleDateString('zh-CN')}`;
                } else {
                    return `${weekOffset}å‘¨åï¼š${monday.toLocaleDateString('zh-CN')} - ${sunday.toLocaleDateString('zh-CN')}`;
                }
            }

            // è®¡ç®—å½“å‰é¡µçš„å‘¨æ”¶ç›Šï¼ˆå½“å‰é¡µæ€»æ”¶ç›Šé™¤ä»¥å½“å‰é¡µæ•°æ®æ¡æ•°ï¼‰
            function calculateWeeklyIncome(weekRecords) {
                if (!weekRecords || weekRecords.length === 0) return 0;

                let totalWeekIncome = 0;
                weekRecords.forEach(record => {
                    const todayProfit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;
                    totalWeekIncome += todayProfit;
                });

                return Math.round(totalWeekIncome / weekRecords.length);
            }

            // è®¡ç®—å½“å‰é¡µçš„å‘¨æ€»æ”¶ç›Š
            function calculateWeeklyTotal(weekRecords) {
                if (!weekRecords || weekRecords.length === 0) return 0;

                let totalWeekIncome = 0;
                weekRecords.forEach(record => {
                    const todayProfit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;
                    totalWeekIncome += todayProfit;
                });

                return Math.round(totalWeekIncome);
            }

            // è®¡ç®—æœˆå¹³å‡æ”¶ç›Š
            function calculateMonthlyAverage(records) {
                if (!records || records.length === 0) return 0;

                let totalIncome = 0;
                let dayCount = 0;

                records.forEach(record => {
                    const todayProfit = parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0;
                    totalIncome += todayProfit;
                    dayCount++;
                });

                return Math.round(totalIncome / dayCount);
            }

            // è·å–æŒ‡å®šå‘¨çš„æ•°æ®
            function getWeekRecords(records, weekOffset) {
                const today = new Date();
                const currentDay = today.getDay();
                const diff = currentDay === 0 ? -6 : 1 - currentDay;

                const monday = new Date(today);
                monday.setDate(today.getDate() + diff + (weekOffset * 7));
                monday.setHours(0, 0, 0, 0);

                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);

                return records.filter(record => {
                    const recordDate = new Date(record.æ—¥æœŸ);
                    return recordDate >= monday && recordDate <= sunday;
                }).sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ));
            }

            function getWeekRangeDates(weekOffset) {
                const today = new Date();
                const currentDay = today.getDay();
                const diff = currentDay === 0 ? -6 : 1 - currentDay;
                const monday = new Date(today);
                monday.setDate(today.getDate() + diff + (weekOffset * 7));
                monday.setHours(0, 0, 0, 0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                const start = `${monday.getFullYear()}-${String(monday.getMonth()+1).padStart(2,'0')}-${String(monday.getDate()).padStart(2,'0')}`;
                const end = `${sunday.getFullYear()}-${String(sunday.getMonth()+1).padStart(2,'0')}-${String(sunday.getDate()).padStart(2,'0')}`;
                return { start, end };
            }

            async function loadWeeklyGuardInputs() {
                const range = getWeekRangeDates(currentWeekOffset);
                const res = await fetch(`/weekly_guard_inputs?start=${range.start}&end=${range.end}`);
                const data = await res.json();
                renderWeeklyGuardInputs(data.items || []);
            }

            function renderWeeklyGuardInputs(items) {
                let container = document.getElementById('weekly-guard-list');
                if (!container) return;
                if (!items.length) {
                    container.textContent = '';
                    return;
                }
                container.innerHTML = items.map(it => {
                    const isAdvanced = it.content && it.content.startsWith('é«˜çº§');
                    const iconName = isAdvanced ? 'é«˜çº§é­”å…½è¦è¯€' : it.content;
                    const iconPath = `/image/Icon/${encodeURIComponent(iconName)}.png`;
                    const datesStr = (it.dates || []).join(',');
                    return `<span class=\"guard-chip\" data-content=\"${it.content}\" data-dates=\"${datesStr}\" onclick=\"openGuardDetail(this)\">\n`+
                        `<img src=\"${iconPath}\" alt=\"${it.content}\" class=\"guard-icon\" onerror=\"this.style.display='none'\">\n`+
                        `<span>${it.content} *${it.count}</span>\n`+
                    `</span>`;
                }).join('');
            }

            function openGuardDetail(el) {
                const content = el.getAttribute('data-content') || '';
                const datesStr = el.getAttribute('data-dates') || '';
                const dates = datesStr ? datesStr.split(',').filter(Boolean) : [];
                const isAdvanced = content.startsWith('é«˜çº§');
                const iconName = isAdvanced ? 'é«˜çº§é­”å…½è¦è¯€' : content;
                const iconPath = `/image/Icon/${encodeURIComponent(iconName)}.png`;
                const modal = document.getElementById('guard-detail-modal');
                const iconEl = document.getElementById('guard-detail-icon');
                const textEl = document.getElementById('guard-detail-text');
                const datesEl = document.getElementById('guard-detail-dates');
                iconEl.src = iconPath;
                iconEl.style.display = '';
                iconEl.onerror = function() { this.style.display = 'none'; };
                textEl.textContent = `${content}`;
                datesEl.textContent = dates.length ? `æ—¥æœŸï¼š${dates.join('ã€')}` : '';
                modal.classList.add('show');
            }

            function closeGuardDetail() {
                const modal = document.getElementById('guard-detail-modal');
                modal.classList.remove('show');
            }

            async function openProfitDetail(dateStr) {
                try {
                    const resp = await fetch('/data');
                    const data = await resp.json();
                    const records = data.records || data.data || [];
                const d = new Date(dateStr);
                const w = d.getDay() || 7;
                const series = [];
                records.forEach(r => {
                    const rd = new Date(r.æ—¥æœŸ);
                    if ((rd.getDay() || 7) === w) {
                        const val = parseFloat(r.ä»Šæ—¥æ”¶ç›Š) || 0;
                        if (val > 0) series.push({ date: rd, value: val });
                    }
                });
                    series.sort((a,b) => a.date - b.date);
                    const values = series.map(s => s.value);
                    const avg = values.length ? Math.round(values.reduce((a,b)=>a+b,0)/values.length) : 0;
                    function renderSparkline(seriesVals, width = 160, height = 40) {
                        if (!seriesVals || seriesVals.length === 0) return `<svg class="sparkline" width="${width}" height="${height}"></svg>`;
                        const min = Math.min(...seriesVals);
                        const max = Math.max(...seriesVals);
                        const n = seriesVals.length;
                        const stepX = width / Math.max(1, n - 1);
                        const scaleY = max === min ? 1 : (height - 6) / (max - min);
                        const points = seriesVals.map((v, i) => {
                            const x = Math.round(i * stepX);
                            const y = Math.round(height - 3 - (v - min) * scaleY);
                            return `${x},${y}`;
                        }).join(' ');
                        return `<svg class="sparkline" width="${width}" height="${height}"><polyline points="${points}"/></svg>`;
                    }
                    const weekdayText = 'ä¸€äºŒä¸‰å››äº”å…­æ—¥'[w - 1];
                    document.getElementById('profit-detail-title').textContent = `å‘¨${weekdayText}èµ°åŠ¿`;
                    document.getElementById('profit-detail-avg').textContent = `å‡å€¼ï¼š${avg.toLocaleString()}`;
                    document.getElementById('profit-detail-chart').innerHTML = renderSparkline(values);
                    const modal = document.getElementById('profit-detail-modal');
                    modal.classList.add('show');
                } catch (e) {}
            }

            function closeProfitDetail() {
                const modal = document.getElementById('profit-detail-modal');
                modal.classList.remove('show');
            }

            async function openTopStats(type) {
                try {
                    const resp = await fetch('/data');
                    const data = await resp.json();
                    const records = data.records || data.data || [];
                    let title = '';
                    let itemsHtml = '';
                    if (type === 'daily') {
                        const arr = records.map(r => ({ date: r.æ—¥æœŸ, value: parseFloat(r.ä»Šæ—¥æ”¶ç›Š) || 0 }))
                            .filter(x => x.value > 0)
                            .sort((a,b) => b.value - a.value)
                            .slice(0, 10);
                        title = 'æ—¥æœ€é«˜æ”¶ç›Šå‰å';
                        itemsHtml = arr.map((x,i) => `
                            <div class=\"top-item\">
                                <div class=\"top-left\">
                                    <div class=\"top-rank ${i<3?('r'+(i+1)):'rx'}\">${i+1}</div>
                                    <div class=\"top-date\">${x.date}</div>
                                </div>
                                <div class=\"top-value\">${x.value.toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else if (type === 'weekly') {
                        function getWeekNumber(date) {
                            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                            const dayNum = d.getUTCDay() || 7;
                            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                        }
                        function getWeekRangeForDate(date) {
                            const currentDay = date.getDay();
                            const diff = currentDay === 0 ? -6 : 1 - currentDay;
                            const monday = new Date(date);
                            monday.setDate(date.getDate() + diff);
                            monday.setHours(0,0,0,0);
                            const sunday = new Date(monday);
                            sunday.setDate(monday.getDate() + 6);
                            sunday.setHours(23,59,59,999);
                            return { start: monday, end: sunday };
                        }
                        const map = {};
                        records.forEach(r => {
                            const d = new Date(r.æ—¥æœŸ);
                            const key = `${d.getFullYear()}-W${getWeekNumber(d)}`;
                            const val = parseFloat(r.ä»Šæ—¥æ”¶ç›Š) || 0;
                            if (!map[key]) {
                                const range = getWeekRangeForDate(d);
                                const start = `${range.start.getFullYear()}-${String(range.start.getMonth()+1).padStart(2,'0')}-${String(range.start.getDate()).padStart(2,'0')}`;
                                const end = `${range.end.getFullYear()}-${String(range.end.getMonth()+1).padStart(2,'0')}-${String(range.end.getDate()).padStart(2,'0')}`;
                                map[key] = { label: `${start} - ${end}`, value: 0 };
                            }
                            map[key].value += val;
                        });
                        const arr = Object.values(map).filter(x => x.value > 0).sort((a,b) => b.value - a.value).slice(0,10);
                        title = 'å‘¨æœ€é«˜æ”¶ç›Šå‰å';
                        itemsHtml = arr.map((x,i) => `
                            <div class=\"top-item\">
                                <div class=\"top-left\">
                                    <div class=\"top-rank ${i<3?('r'+(i+1)):'rx'}\">${i+1}</div>
                                    <div class=\"top-date\">${x.label}</div>
                                </div>
                                <div class=\"top-value\">${x.value.toLocaleString()}</div>
                            </div>
                        `).join('');
                    } else if (type === 'monthly') {
                        const map = {};
                        records.forEach(r => {
                            const d = new Date(r.æ—¥æœŸ);
                            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                            const val = parseFloat(r.ä»Šæ—¥æ”¶ç›Š) || 0;
                            if (!map[key]) map[key] = 0;
                            map[key] += val;
                        });
                        const arr = Object.entries(map).map(([label,value]) => ({ label, value })).filter(x => x.value > 0).sort((a,b)=>b.value-a.value).slice(0,10);
                        title = 'æœˆæœ€é«˜æ”¶ç›Šå‰å';
                        itemsHtml = arr.map((x,i) => `
                            <div class=\"top-item\">
                                <div class=\"top-left\">
                                    <div class=\"top-rank ${i<3?('r'+(i+1)):'rx'}\">${i+1}</div>
                                    <div class=\"top-date\">${x.label}</div>
                                </div>
                                <div class=\"top-value\">${x.value.toLocaleString()}</div>
                            </div>
                        `).join('');
                    }
                    document.getElementById('top-stats-title').textContent = title;
                    document.getElementById('top-stats-list').innerHTML = itemsHtml || '';
                    document.getElementById('top-stats-modal').classList.add('show');
                } catch (e) {}
            }

            function closeTopStats() {
                document.getElementById('top-stats-modal').classList.remove('show');
            }

            async function saveGuardInput() {
                const date = document.getElementById('æ—¥æœŸ').value;
                const input = document.getElementById('guard-content-input');
                const content = (input.value || '').trim();
                if (!date) {
                    showToast('è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'error');
                    return;
                }
                if (!content) {
                    showToast('è¯·è¾“å…¥å†…å®¹', 'error');
                    return;
                }
                const resp = await fetch('/save_guard_input', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, content })
                });
                const result = await resp.json();
                if (result.success) {
                    input.value = '';
                    showToast('ä¿å­˜æˆåŠŸ');
                    await loadWeeklyGuardInputs();
                } else {
                    showToast('ä¿å­˜å¤±è´¥', 'error');
                }
            }

            // åŒå‡»æ—¥æœŸè·³è½¬åˆ°è¯¥æ—¥æœŸè¿›è¡Œç¼–è¾‘
            function jumpToDate(dateStr) {
                // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„å€¼
                datePicker.setDate(dateStr);

                // åŠ è½½è¯¥æ—¥æœŸçš„æ•°æ®
                loadDailyData(dateStr);
                
                // åŠ è½½checkboxçŠ¶æ€
                loadCheckboxes(dateStr);

                // æ»šåŠ¨åˆ°æ•°æ®å½•å…¥åŒºåŸŸ
                document.querySelector('#add-form').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // æ·»åŠ è§†è§‰æç¤º
                const dateInput = document.getElementById('æ—¥æœŸ');
                dateInput.classList.add('ring-2', 'ring-blue-500');
                setTimeout(() => {
                    dateInput.classList.remove('ring-2', 'ring-blue-500');
                }, 2000);
            }



            // åˆ‡æ¢å‘¨çš„å‡½æ•°
            function changeWeek(offset) {
                if (offset === 0) {
                    currentWeekOffset = 0;
                } else {
                    currentWeekOffset += offset;
                }
                loadDataTable();
                loadWeeklyGuardInputs();
            }

            // åŠ è½½å¤‡æ³¨æ•°æ®
            async function loadNotes() {
                try {
                    const response = await fetch('/get_notes');
                    const notes = await response.json();

                    // ä¿å­˜å½“å‰çŠ¶æ€ä¸ºä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                    previousNotesState = { ...notes };

                    // å¡«å……è¡¨å•
                    for (let i = 1; i <= 7; i++) {
                        const noteKey = `note${i}`;
                        const noteInput = document.getElementById(noteKey);
                        if (noteInput && notes[noteKey] !== undefined) {
                            noteInput.value = notes[noteKey];
                            // åŠ è½½åæ˜¾ç¤ºé¢„è§ˆ
                            previewNote(noteKey);
                        }
                    }

                    // æ˜¾ç¤ºæ’¤å›æŒ‰é’®ï¼ˆå¦‚æœæœ‰ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€ï¼‰
                    const undoBtn = document.getElementById('undo-notes-btn');
                    if (undoBtn && previousNotesState) {
                        undoBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('åŠ è½½å¤‡æ³¨å¤±è´¥:', error);
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç”¨æˆ·æç¤º
                }
            }

            // éªŒè¯å¹¶æ ¼å¼åŒ–å¤‡æ³¨æ•°æ®
            function validateAndFormatNote(noteText) {
                if (!noteText) return { plainText: noteText, html: noteText };

                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»¥é€—å·åˆ†éš”çš„ä¸‰æ®µå†…å®¹
                const parts = noteText.split(',');
                if (parts.length !== 3) {
                    return { plainText: noteText, html: noteText }; // æ ¼å¼ä¸æ­£ç¡®ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
                }

                const [part1, part2, part3] = parts;

                // å¤„ç†ç¬¬ä¸€æ®µï¼ˆæ²¡æœ‰ä»»ä½•checkï¼‰
                let formattedPart1 = part1.trim();

                // å¤„ç†ç¬¬äºŒæ®µï¼ˆå¿…é¡»æ˜¯ä»¥/åˆ†å‰²çš„ä¸‰å°æ®µå†…å®¹ï¼‰
                let plainPart2 = '';
                let equipmentStatus = false; // æ½œé¾™è£…å¤‡çŠ¶æ€
                let runeStatus = false; // å® ç‰©ç¬¦çŸ³çŠ¶æ€

                const subParts = part2.split('/');
                if (subParts.length === 3) {
                    const [subPart1, subPart2, subPart3] = subParts;
                    plainPart2 = `${subPart1.trim()}/${subPart2.trim()}/${subPart3.trim()}`;

                    // æ£€æŸ¥ç¬¬ä¸€ä¸ªå­éƒ¨åˆ†æ˜¯å¦æ»¡è¶³æ¡ä»¶
                    const match1 = subPart1.trim().match(/(\d+)([\u4e00-\u9fa5]+)/);
                    if (match1) {
                        const num = parseInt(match1[1]);
                        const unit = match1[2];

                        if (unit === 'æ”»' && num >= 53) {
                            equipmentStatus = true;
                        } else if (unit === 'é˜²' && num >= 40) {
                            equipmentStatus = true;
                        } else if (unit === 'é€Ÿ' && num >= 32) {
                            equipmentStatus = true;
                        } else if (unit === 'çµ' && num >= 32) {
                            equipmentStatus = true;
                        }
                    }

                    // æ£€æŸ¥ç¬¬äºŒä¸ªå­éƒ¨åˆ†æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼ˆåªè¦æœ‰ä¸€ä¸ªæ»¡è¶³å°±è®¾ä¸ºtrueï¼‰
                    const match2 = subPart2.trim().match(/(\d+)([\u4e00-\u9fa5]+)/);
                    if (match2 && match2[2] === 'é˜²' && parseInt(match2[1]) >= 66) {
                        equipmentStatus = equipmentStatus && true;
                    } else {
                        equipmentStatus = false;
                    }

                    // æ£€æŸ¥ç¬¬ä¸‰ä¸ªå­éƒ¨åˆ†æ˜¯å¦æ»¡è¶³æ¡ä»¶
                    if (subPart3.trim().startsWith('6')) {
                        runeStatus = true;
                    }
                } else {
                    plainPart2 = part2.trim();
                }

                // å¤„ç†ç¬¬ä¸‰æ®µï¼ˆæ£€æŸ¥æ˜¯å¦å·²è§‰é†’ï¼‰
                let plainPart3 = part3.trim();
                const isAwakened = plainPart3 === 'å·²è§‰é†’';

                return {
                    plainText: `${formattedPart1},${plainPart2},${plainPart3}`,
                    equipmentStatus: equipmentStatus,
                    runeStatus: runeStatus,
                    isAwakened: isAwakened
                };
            }

            // åŠ è½½å® ç‰©å¤´åƒ
            function loadPetAvatar(noteId) {
                const noteInput = document.getElementById(noteId);
                const avatarElement = document.getElementById(`avatar-${noteId}`);
                
                if (noteInput && avatarElement) {
                    const noteText = noteInput.value;
                    
                    if (noteText) {
                        // è§£æå® ç‰©åç§°
                        const parts = noteText.split(',');
                        if (parts.length >= 1) {
                            const petName = parts[0].trim();
                            // å°è¯•åŠ è½½å¤´åƒï¼Œä½¿ç”¨æœåŠ¡å™¨é…ç½®çš„è·¯å¾„
                            const avatarPath = `/image/Icon/${petName}.png`;
                            avatarElement.innerHTML = `<img src="${avatarPath}" alt="${petName}" class="w-full h-full object-cover" onerror="this.parentNode.innerHTML = '<div class=\'w-full h-full flex items-center justify-center bg-gray-100 text-gray-600 text-xs p-1 text-center\'>${petName}</div>';">`;
                        } else {
                            // å¦‚æœæ²¡æœ‰åç§°ï¼Œæ˜¾ç¤ºç©ºç™½
                            avatarElement.innerHTML = '';
                        }
                    } else {
                        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºç™½
                        avatarElement.innerHTML = '';
                    }
                }
            }
            
            // é¢„è§ˆå¤‡æ³¨æ ¼å¼
            function previewNote(noteId) {
                const noteInput = document.getElementById(noteId);
                const previewElement = document.getElementById(`preview-${noteId}`);
                
                // åŠ è½½å® ç‰©å¤´åƒ
                loadPetAvatar(noteId);

                if (noteInput && previewElement) {
                    const noteText = noteInput.value;
                    const formattedResult = validateAndFormatNote(noteText);

                    if (noteText) {
                        // æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
                        const parts = noteText.split(',');
                        if (parts.length === 3) {
                            const subParts = parts[1].split('/');

                            // åˆ›å»ºé¢„è§ˆHTML
                            let previewHTML = '';

                            // æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨ - æ”¹ä¸ºæ°´å¹³æ’åˆ—
                            previewHTML += '<div class="flex items-center gap-4">';

                            // 1. æ½œé¾™è£…å¤‡çŠ¶æ€
                            const equipmentLight = formattedResult.equipmentStatus ?
                                '<span class="inline-block w-4 h-4 rounded-full bg-green-500 relative"><span class="absolute inset-0 rounded-full bg-green-400 blur-sm opacity-70"></span></span>' :
                                '<span class="inline-block w-4 h-4 rounded-full bg-red-500 relative"><span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span></span>';
                            previewHTML += `<div class="flex items-center gap-2">
                             <span class="text-sm text-gray-700">è£…å¤‡</span>
                             ${equipmentLight}
                         </div>`;

                            // 2. å® ç‰©ç¬¦çŸ³çŠ¶æ€
                            const runeLight = formattedResult.runeStatus ?
                                '<span class="inline-block w-4 h-4 rounded-full bg-green-500 relative"><span class="absolute inset-0 rounded-full bg-green-400 blur-sm opacity-70"></span></span>' :
                                '<span class="inline-block w-4 h-4 rounded-full bg-red-500 relative"><span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span></span>';
                            previewHTML += `<div class="flex items-center gap-2">
                             <span class="text-sm text-gray-700">ç¬¦çŸ³</span>
                             ${runeLight}
                         </div>`;

                            // 3. è§‰é†’çŠ¶æ€
                            const awakenLight = formattedResult.isAwakened ?
                                '<span class="inline-block w-4 h-4 rounded-full bg-green-500 relative"><span class="absolute inset-0 rounded-full bg-green-400 blur-sm opacity-70"></span></span>' :
                                '<span class="inline-block w-4 h-4 rounded-full bg-red-500 relative"><span class="absolute inset-0 rounded-full bg-red-400 blur-sm opacity-70"></span></span>';
                            previewHTML += `<div class="flex items-center gap-2">
                              <span class="text-sm text-gray-700">è§‰é†’</span>
                              ${awakenLight}
                          </div>`;

                            previewHTML += '</div>';

                            previewElement.innerHTML = previewHTML;
                        } else {
                            previewElement.innerHTML = '<div class="text-sm text-red-500">æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨: åç§°,å±æ€§/å±æ€§/å±æ€§,è§‰é†’çŠ¶æ€</div>';
                        }

                        previewElement.style.display = 'block';
                    } else {
                        previewElement.style.display = 'none';
                    }
                }
            }

            // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
            function addNoteInputListeners() {
                for (let i = 1; i <= 7; i++) {
                    const noteId = `note${i}`;
                    const noteInput = document.getElementById(noteId);

                    if (noteInput) {
                        noteInput.addEventListener('input', function () {
                            previewNote(noteId);
                        });

                        // åˆå§‹åŠ è½½æ—¶ä¹Ÿé¢„è§ˆ
                        if (noteInput.value) {
                            previewNote(noteId);
                        }
                    }
                }
            }

            // ä¿å­˜å¤‡æ³¨æ•°æ®
            async function saveNotes() {
                try {
                    // æ”¶é›†è¡¨å•æ•°æ®
                    const notesData = {};
                    for (let i = 1; i <= 7; i++) {
                        const noteKey = `note${i}`;
                        const noteInput = document.getElementById(noteKey);
                        if (noteInput) {
                            // éªŒè¯å¹¶æ ¼å¼åŒ–å¤‡æ³¨
                            const formattedNote = validateAndFormatNote(noteInput.value);
                            notesData[noteKey] = formattedNote.plainText;
                        }
                    }

                    // å‘é€åˆ°æœåŠ¡å™¨
                    const response = await fetch('/save_notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(notesData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log('æ½œé¾™åœ¨æ¸Šè¯¦æƒ…ä¿å­˜æˆåŠŸ');
                        // ä¿å­˜æˆåŠŸåæ›´æ–°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                        previousNotesState = { ...notesData };
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æˆåŠŸæç¤º
                        showToast('æ½œé¾™åœ¨æ¸Šè¯¦æƒ…ä¿å­˜æˆåŠŸ');
                    } else {
                        console.error('æ½œé¾™åœ¨æ¸Šè¯¦æƒ…ä¿å­˜å¤±è´¥:', result.message);
                        showToast('æ½œé¾™åœ¨æ¸Šè¯¦æƒ…ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ½œé¾™åœ¨æ¸Šè¯¦æƒ…æ—¶å‡ºé”™:', error);
                    showToast('ä¿å­˜æ½œé¾™åœ¨æ¸Šè¯¦æƒ…æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
                }
            }

            // ç®€å•çš„æç¤ºæ¡†å‡½æ•°
            function showToast(message, type = 'success') {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå…ƒç´ 
                let toast = document.getElementById('toast-message');

                if (!toast) {
                    // åˆ›å»ºæ–°çš„toastå…ƒç´ 
                    toast = document.createElement('div');
                    toast.id = 'toast-message';
                    toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0';
                    document.body.appendChild(toast);
                }

                // è®¾ç½®æ¶ˆæ¯å†…å®¹å’Œæ ·å¼
                toast.textContent = message;

                // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„èƒŒæ™¯è‰²
                if (type === 'error') {
                    toast.classList.remove('bg-green-500');
                    toast.classList.add('bg-red-500');
                } else {
                    toast.classList.remove('bg-red-500');
                    toast.classList.add('bg-green-500');
                }
                toast.classList.add('text-white', 'font-bold');

                // æ˜¾ç¤ºtoast
                toast.style.opacity = '1';

                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    toast.style.opacity = '0';
                }, 3000);
            }

            // æ‰“å¼€å¤‡æ³¨ç®¡ç†æ¨¡æ€æ¡†
            function openNotesModal() {
                const modal = document.getElementById('notes-modal');
                modal.classList.remove('hidden');

                // åŠ è½½å¤‡æ³¨æ•°æ®
                loadNotes();
            }

            // å…³é—­å¤‡æ³¨ç®¡ç†æ¨¡æ€æ¡†
            function closeNotesModal() {
                const modal = document.getElementById('notes-modal');

                // å…³é—­æ¨¡æ€æ¡†
                modal.classList.add('hidden');
            }

            // å˜é‡ç”¨äºå­˜å‚¨ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
            let previousNotesState = null;
            let previousExpenseDetailsState = null;

            // å¤‡æ³¨æ’¤å›åŠŸèƒ½
            function undoNotes() {
                if (previousNotesState) {
                    // æ¢å¤åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                    for (let i = 1; i <= 7; i++) {
                        const noteKey = `note${i}`;
                        const noteInput = document.getElementById(noteKey);
                        if (noteInput && previousNotesState[noteKey] !== undefined) {
                            noteInput.value = previousNotesState[noteKey];
                            previewNote(noteKey);
                        }
                    }
                    showToast('å·²æ¢å¤åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€');
                }
            }

            // æ¶ˆè€—è¯¦æƒ…æ’¤å›åŠŸèƒ½
            function undoExpenseDetails() {
                if (previousExpenseDetailsState) {
                    // æ¢å¤åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                    document.getElementById('expense-details').value = previousExpenseDetailsState.details || '';
                    showToast('å·²æ¢å¤åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€');
                }
            }

            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('DOMContentLoaded', function () {
                // æ‰“å¼€å¤‡æ³¨æ¨¡æ€æ¡†æŒ‰é’®
                const openBtn = document.getElementById('open-notes-btn');
                if (openBtn) {
                    openBtn.addEventListener('click', openNotesModal);
                }

                // å…³é—­å¤‡æ³¨æ¨¡æ€æ¡†æŒ‰é’®
                const closeBtn = document.getElementById('close-notes-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeNotesModal);
                }

                // ä¿å­˜æŒ‰é’®
                const saveBtn = document.getElementById('save-notes-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveNotes);
                }

                const saveGuardBtn = document.getElementById('save-guard-content-btn');
                if (saveGuardBtn) {
                    saveGuardBtn.addEventListener('click', saveGuardInput);
                }

                const guardModal = document.getElementById('guard-detail-modal');
                const guardClose = document.getElementById('guard-detail-close');
                if (guardClose) {
                    guardClose.addEventListener('click', closeGuardDetail);
                }
                if (guardModal) {
                    guardModal.addEventListener('click', function(e) {
                        if (e.target === guardModal) closeGuardDetail();
                    });
                }

                const profitModal = document.getElementById('profit-detail-modal');
                const profitClose = document.getElementById('profit-detail-close');
                if (profitClose) {
                    profitClose.addEventListener('click', closeProfitDetail);
                }
                if (profitModal) {
                    profitModal.addEventListener('click', function(e) {
                        if (e.target === profitModal) closeProfitDetail();
                    });
                }

                const topStatsModal = document.getElementById('top-stats-modal');
                const topStatsClose = document.getElementById('top-stats-close');
                if (topStatsClose) {
                    topStatsClose.addEventListener('click', closeTopStats);
                }
                if (topStatsModal) {
                    topStatsModal.addEventListener('click', function(e) {
                        if (e.target === topStatsModal) closeTopStats();
                    });
                }

                const maxDaily = document.getElementById('max-daily-income');
                const maxWeekly = document.getElementById('max-weekly-income');
                const maxMonthly = document.getElementById('max-monthly-income');
                if (maxDaily) maxDaily.addEventListener('click', () => openTopStats('daily'));
                if (maxWeekly) maxWeekly.addEventListener('click', () => openTopStats('weekly'));
                if (maxMonthly) maxMonthly.addEventListener('click', () => openTopStats('monthly'));

                // æ’¤å›å¤‡æ³¨æŒ‰é’®
                const undoNotesBtn = document.getElementById('undo-notes-btn');
                if (undoNotesBtn) {
                    undoNotesBtn.addEventListener('click', undoNotes);
                }

                // æ·»åŠ å¤‡æ³¨è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
                addNoteInputListeners();

                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­ï¼ˆè‡ªåŠ¨ä¿å­˜å¹¶å…³é—­ï¼‰
                const notesModal = document.getElementById('notes-modal');
                if (notesModal) {
                    notesModal.addEventListener('click', function (e) {
                        if (e.target === notesModal) {
                            closeNotesModal();
                        }
                    });
                }

                // ESCé”®å…³é—­æ¨¡æ€æ¡†
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        const notesModal = document.getElementById('notes-modal');
                        const expenseModal = document.getElementById('expense-details-modal');
                        const imageModal = document.getElementById('image-modal');

                        if (notesModal && !notesModal.classList.contains('hidden')) {
                            closeNotesModal();
                        } else if (expenseModal && !expenseModal.classList.contains('hidden')) {
                            closeExpenseDetailsModal();
                        } else if (imageModal && !imageModal.classList.contains('hidden')) {
                            closeImages();
                        }
                    }
                });

                // å…³é—­æ¶ˆè€—è¯¦æƒ…æ¨¡æ€æ¡†æŒ‰é’®
                const closeExpenseBtn = document.getElementById('close-expense-details-btn');
                if (closeExpenseBtn) {
                    closeExpenseBtn.addEventListener('click', saveExpenseDetails);
                }

                // ä¿å­˜æ¶ˆè€—è¯¦æƒ…æŒ‰é’®
                const saveExpenseBtn = document.getElementById('save-expense-details-btn');
                if (saveExpenseBtn) {
                    saveExpenseBtn.addEventListener('click', saveExpenseDetails);
                }

                // æ’¤å›æ¶ˆè€—è¯¦æƒ…æŒ‰é’®
                const undoExpenseBtn = document.getElementById('undo-expense-details-btn');
                if (undoExpenseBtn) {
                    undoExpenseBtn.addEventListener('click', undoExpenseDetails);
                }

                // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¶ˆè€—è¯¦æƒ…æ¨¡æ€æ¡†
                document.getElementById('expense-details-modal').addEventListener('click', function (e) {
                    if (e.target === this) {
                        saveExpenseDetails();
                    }
                });

                // ESCé”®å…³é—­æ¨¡æ€æ¡†
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        const notesModal = document.getElementById('notes-modal');
                        const expenseModal = document.getElementById('expense-details-modal');
                        const imageModal = document.getElementById('image-modal');

                        if (!notesModal.classList.contains('hidden')) {
                            closeNotesModal();
                        } else if (!expenseModal.classList.contains('hidden')) {
                            saveExpenseDetails();
                        } else if (!imageModal.classList.contains('hidden')) {
                            closeImages();
                        }
                    }
                });

                // ç‚¹å‡»å›¾ç‰‡æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                document.getElementById('image-modal').addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeImages();
                    }
                });

                // æ·»åŠ å¤‡æ³¨è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
                addNoteInputListeners();
            });

            // å›¾ç‰‡ç›¸å…³åŠŸèƒ½
            async function showImages(date) {
                try {
                    const response = await fetch(`/get_images?date=${date}`);
                    const data = await response.json();
                    const images = Array.isArray(data) ? data : data.files || [];

                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '';

                    if (images.length === 0) {
                        gallery.innerHTML = '<p class="text-gray-500 text-center py-8">è¯¥æ—¥æœŸæ²¡æœ‰å›¾ç‰‡</p>';
                    } else {
                        images.forEach(img => {
                            const imgName = typeof img === 'string' ? img : img.filename || img.name;
                            const imgElement = document.createElement('img');
                            imgElement.src = `/${imgName}`;
                            imgElement.alt = imgName;
                            imgElement.className = 'cursor-pointer hover:opacity-75 transition-opacity max-w-full h-auto rounded';
                            imgElement.onclick = () => showFullImage(`/${imgName}`);

                            const container = document.createElement('div');
                            container.className = 'relative p-2';
                            container.appendChild(imgElement);

                            gallery.appendChild(container);
                        });
                    }

                    document.getElementById('image-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                    const gallery = document.getElementById('image-gallery');
                    gallery.innerHTML = '<p class="text-red-500 text-center py-8">åŠ è½½å›¾ç‰‡å¤±è´¥</p>';
                    document.getElementById('image-modal').classList.remove('hidden');
                }
            }

            function closeImages() {
                document.getElementById('image-modal').classList.add('hidden');
            }

            function showFullImage(src) {
                // åˆ›å»ºæˆ–è·å–é¢„è§ˆå®¹å™¨
                let previewContainer = document.getElementById('image-preview-container');
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.id = 'image-preview-container';
                    previewContainer.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-[60] cursor-zoom-out transition-all duration-300';
                    previewContainer.onclick = function() {
                        this.classList.add('opacity-0');
                        setTimeout(() => this.remove(), 300);
                    };
                    document.body.appendChild(previewContainer);
                    // æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿä»¥ç¡®ä¿è¿‡æ¸¡æ•ˆæœæ˜¾ç¤º
                    setTimeout(() => {
                        previewContainer.style.opacity = '1';
                    }, 10);
                } else {
                    previewContainer.innerHTML = '';
                }
                
                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.src = src;
                img.className = 'max-w-[90%] max-h-[90vh] object-contain shadow-xl transition-transform duration-300 transform scale-95';
                img.onload = function() {
                    this.classList.remove('scale-95');
                    this.classList.add('scale-100');
                };
                img.onclick = function(e) {
                    e.stopPropagation(); // é˜²æ­¢ç‚¹å‡»å›¾ç‰‡æ—¶å…³é—­é¢„è§ˆ
                };
                
                previewContainer.appendChild(img);
            }

            // æ ¹æ®é“¶å¸æ•°é‡è®¾ç½®é¢œè‰²æ ·å¼
            function getSilverColorStyle(amount) {
                const numStr = Math.abs(amount).toString();
                const length = numStr.replace(/,/g, '').length;

                if (length >= 9) {
                    return 'color: red; font-size: 0.85em;'; // 9ä½æ•°åŠä»¥ä¸Šæ˜¾ç¤ºçº¢è‰²å¹¶ç¨å¾®ç¼©å°å­—ä½“
                } else if (length === 8) {
                    return 'color: red; font-size: 0.9em;'; // 8ä½æ•°æ˜¾ç¤ºçº¢è‰²å¹¶ç¨å¾®ç¼©å°å­—ä½“
                } else if (length === 7) {
                    return 'color: purple;'; // 7ä½æ•°æ˜¾ç¤ºç´«è‰²
                } else if (length === 6) {
                    return 'color: orange;'; // 6ä½æ•°æ˜¾ç¤ºæ©™è‰²
                } else if (length === 5) {
                    return 'color: blue;'; // 5ä½æ•°æ˜¾ç¤ºè“è‰²
                }
                return 'color: text-orange-600;'; // é»˜è®¤é¢œè‰²
            }

            // æ ¹æ®é‡‘é¢å’Œç±»å‹è·å–å¯¹åº”çš„æ ·å¼ç±»
            function getAmountClass(amount, type = 'profit') {
                // ä¸åŒç±»å‹ä½¿ç”¨ä¸åŒçš„æ ·å¼é€»è¾‘
                if (type === 'remaining') {
                    // å‰©ä½™åˆ—ï¼šæ ¹æ®æ•°å­—ä½æ•°æ˜¾ç¤ºä¸åŒé¢œè‰²ï¼Œä¸æ·»åŠ èƒŒæ™¯è‰²
                    const numStr = Math.abs(amount).toString();
                    const length = numStr.replace(/,/g, '').length;
                    
                    if (length >= 8) {
                        return 'text-red-600'; // 8ä½æ•°åŠä»¥ä¸Šæ˜¾ç¤ºçº¢è‰²
                    } else if (length === 7) {
                        return 'text-purple-600'; // 7ä½æ•°æ˜¾ç¤ºç´«è‰²
                    } else if (length === 6) {
                        return 'text-orange-600'; // 6ä½æ•°æ˜¾ç¤ºæ©™è‰²
                    } else {
                        return 'text-blue-600'; // 5ä½æ•°åŠä»¥ä¸‹æ˜¾ç¤ºè“è‰²
                    }
                } else if (type === 'expense') {
                    // æ¶ˆè€—åˆ—ï¼šä¸åšé¢œè‰²å˜åŒ–ï¼Œå§‹ç»ˆä¸ºé»‘è‰²
                    return 'text-gray-900';
                } else if (type === 'profit-container') {
                    // æ”¶ç›Šåˆ—å®¹å™¨ï¼šæ ¹æ®é‡‘é¢è®¾ç½®èƒŒæ™¯è‰²ï¼Œåº”ç”¨åˆ°æ•´ä¸ªå®¹å™¨
                    let className = amount >= 0 ? 'text-white font-bold' : 'text-red-600';
                    
                    if (amount > 0) {
                        if (amount > 200000) {
                            className += ' bg-red-500'; // è¶…è¿‡20wæ˜¾ç¤ºçº¢è‰²èƒŒæ™¯
                        } else if (amount > 100000) {
                            className += ' bg-purple-500'; // ä½äº20wé«˜äº10wæ˜¾ç¤ºç´«è‰²èƒŒæ™¯
                        } else {
                            className += ' bg-gray-300 text-gray-800'; // ä½äº10wæ˜¾ç¤ºç°è‰²èƒŒæ™¯
                        }
                    }
                    
                    return className;
                } else {
                    // æ”¶ç›Šåˆ—ï¼šæ ¹æ®é‡‘é¢è®¾ç½®èƒŒæ™¯è‰²ï¼ˆä¿ç•™ç”¨äºå…¼å®¹ï¼‰
                    let className = amount >= 0 ? 'text-white font-bold' : 'text-red-600';
                    
                    if (amount > 0) {
                        if (amount > 200000) {
                            className += ' bg-red-500'; // è¶…è¿‡20wæ˜¾ç¤ºçº¢è‰²èƒŒæ™¯
                        } else if (amount > 100000) {
                            className += ' bg-purple-500'; // ä½äº20wé«˜äº10wæ˜¾ç¤ºç´«è‰²èƒŒæ™¯
                        } else {
                            className += ' bg-gray-300 text-gray-800'; // ä½äº10wæ˜¾ç¤ºç°è‰²èƒŒæ™¯
                        }
                    }
                    
                    return className;
                }
            }
            
            // å­˜å‚¨æœ‰æ¶ˆè€—è¯¦æƒ…çš„æ—¥æœŸ
            const datesWithExpenseDetails = new Set();
            
            // é¢„åŠ è½½æœ‰æ¶ˆè€—è¯¦æƒ…çš„æ—¥æœŸ
            async function loadDatesWithExpenseDetails() {
                try {
                    // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä»æœåŠ¡å™¨è·å–æœ‰è¯¦æƒ…çš„æ—¥æœŸåˆ—è¡¨
                    const response = await fetch('/get_dates_with_expense_details');
                    const data = await response.json();
                    data.forEach(date => datesWithExpenseDetails.add(date));
                } catch (error) {
                    console.error('åŠ è½½æœ‰æ¶ˆè€—è¯¦æƒ…çš„æ—¥æœŸå¤±è´¥:', error);
                    // å¦‚æœè·å–å¤±è´¥ï¼Œé»˜è®¤é‡‘é¢å¤§äº0çš„æ—¥æœŸéƒ½æœ‰è¯¦æƒ…
                    try {
                        // åœ¨é”™è¯¯å¤„ç†ä¸­è·å–æ•°æ®ï¼Œç¡®ä¿recordsæœ‰å®šä¹‰
                        const dataResponse = await fetch('/data');
                        const data = await dataResponse.json();
                        const records = data.records || data.data || [];
                        records.forEach(record => {
                            if (parseFloat(record.æ¶ˆè€—é“¶å¸ || 0) > 0) {
                                datesWithExpenseDetails.add(record.æ—¥æœŸ);
                            }
                        });
                    } catch (dataError) {
                        console.error('è·å–æ•°æ®å¤±è´¥:', dataError);
                        // å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™ä¸æ·»åŠ ä»»ä½•æ—¥æœŸ
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆè€—è¯¦æƒ…
            function hasExpenseDetails(date) {
                return datesWithExpenseDetails.has(date);
            }

            // æ‰“å¼€æ¶ˆè€—è¯¦æƒ…æ¨¡æ€æ¡†
            function openExpenseDetails(date, amount) {
                if (amount <= 0) return; // å½“ä¸º0æ—¶åŒå‡»æ²¡æœ‰æ•ˆæœ

                const modal = document.getElementById('expense-details-modal');
                const expenseDate = document.getElementById('expense-date');
                const expenseAmount = document.getElementById('expense-amount');
                const expenseDetails = document.getElementById('expense-details');

                // è®¾ç½®æ—¥æœŸå’Œé‡‘é¢
                expenseDate.value = date;
                expenseAmount.value = amount.toLocaleString();

                // åŠ è½½å·²ä¿å­˜çš„è¯¦æƒ…
                loadExpenseDetails(date);

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.classList.remove('hidden');
            }

            // å…³é—­æ¶ˆè€—è¯¦æƒ…æ¨¡æ€æ¡†
            function closeExpenseDetailsModal() {
                const modal = document.getElementById('expense-details-modal');
                modal.classList.add('hidden');
            }

            // åŠ è½½æ¶ˆè€—è¯¦æƒ…
            async function loadExpenseDetails(date) {
                try {
                    const response = await fetch(`/get_expense_details?date=${date}`);
                    const data = await response.json();

                    // ä¿å­˜å½“å‰çŠ¶æ€ä¸ºä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                    previousExpenseDetailsState = {
                        date: date,
                        details: data.details || ''
                    };

                    if (data.details) {
                        document.getElementById('expense-details').value = data.details;
                    } else {
                        document.getElementById('expense-details').value = '';
                    }

                    // æ˜¾ç¤ºæ’¤å›æŒ‰é’®ï¼ˆå¦‚æœæœ‰ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€ï¼‰
                    const undoBtn = document.getElementById('undo-expense-details-btn');
                    if (undoBtn && previousExpenseDetailsState) {
                        undoBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¶ˆè€—è¯¦æƒ…å¤±è´¥:', error);
                    document.getElementById('expense-details').value = '';
                }
            }

            // ä¿å­˜æ¶ˆè€—è¯¦æƒ…
            async function saveExpenseDetails() {
                const date = document.getElementById('expense-date').value;
                const details = document.getElementById('expense-details').value;

                try {
                    const response = await fetch('/save_expense_details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ date, details })
                    });

                    const result = await response.json();
                    if (result.success) {
                        // ä¿å­˜æˆåŠŸåæ›´æ–°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
                        previousExpenseDetailsState = { date, details };
                        // æ·»åŠ æˆåŠŸæç¤º
                        showToast('æ¶ˆè€—è¯¦æƒ…ä¿å­˜æˆåŠŸ');
                        closeExpenseDetailsModal();
                    } else {
                        console.error('ä¿å­˜å¤±è´¥:', result.message);
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ¶ˆè€—è¯¦æƒ…å¤±è´¥:', error);
                }
            }

            // è¡¨å•æäº¤å¤„ç†
            document.getElementById('add-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const æ—¥æœŸ = document.getElementById('æ—¥æœŸ').value;
                const å‰©ä½™é“¶å¸ = document.getElementById('å‰©ä½™é“¶å¸').value;
                const æ¶ˆè€—é“¶å¸ = document.getElementById('æ¶ˆè€—é“¶å¸').value;

                // å…ˆä¸Šä¼ å›¾ç‰‡
                const files = document.getElementById('å›¾ç‰‡ä¸Šä¼ ').files;
                if (files.length > 0) {
                    for (let file of files) {
                        const formData = new FormData();
                        formData.append('image', file);
                        formData.append('date', æ—¥æœŸ);

                        try {
                            const response = await fetch('/upload', {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
                            if (!result.success) {
                                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', result.message);
                            }
                        } catch (error) {
                            console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                        }
                    }
                }

                // å†æäº¤æ•°æ®
                const response = await fetch('/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ æ—¥æœŸ, å‰©ä½™é“¶å¸, æ¶ˆè€—é“¶å¸ })
                });

                if (response.ok) {
                    location.reload();
                }
            });
        </script>

        <!-- å¼•å…¥Chart.jsåº“ -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- æ”¶å…¥æ¶ˆè€—å˜åŒ–å›¾è¡¨è„šæœ¬ -->
        <script>
            // ç»˜åˆ¶æ”¶å…¥æ¶ˆè€—å˜åŒ–å›¾è¡¨
            async function loadIncomeExpenseChart() {
                try {
                    // è·å–æ‰€æœ‰æ•°æ®
                    const response = await fetch('/data');
                    const data = await response.json();
                    const records = data.records || data.data || [];

                    // æŒ‰æ—¥æœŸæ’åºå¹¶å–æœ€è¿‘50æ¡è®°å½•
                    const sortedRecords = [...records].sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ)).slice(-50);

                    // å‡†å¤‡å›¾è¡¨æ•°æ®
                    const dates = sortedRecords.map(record => {
                        const date = new Date(record.æ—¥æœŸ);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    });

                    const incomeData = sortedRecords.map(record => parseFloat(record.ä»Šæ—¥æ”¶ç›Š) || 0);
                    const expenseData = sortedRecords.map(record => parseFloat(record.æ¶ˆè€—é“¶å¸) || 0);

                    // åˆ›å»ºå›¾è¡¨
                    const ctx = document.getElementById('incomeExpenseChart').getContext('2d');

                    // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œé”€æ¯å®ƒ
                    if (window.incomeExpenseChartInstance) {
                        window.incomeExpenseChartInstance.destroy();
                    }

                    window.incomeExpenseChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                                {
                                    label: 'æ¯æ—¥æ”¶å…¥',
                                    data: incomeData,
                                    borderColor: '#10b981', // ç»¿è‰²
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: false
                                },
                                {
                                    label: 'æ¯æ—¥æ¶ˆè€—',
                                    data: expenseData,
                                    borderColor: '#f59e0b', // æ©™è‰²
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45,
                                        autoSkip: true,
                                        maxTicksLimit: 10
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += context.parsed.y.toLocaleString();
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('åŠ è½½æ”¶å…¥æ¶ˆè€—å›¾è¡¨å¤±è´¥:', error);
                }
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
            document.addEventListener('DOMContentLoaded', function () {
                // ç­‰å¾…DOMå’Œæ•°æ®åŠ è½½å®Œæˆåå†ç»˜åˆ¶å›¾è¡¨
                setTimeout(loadIncomeExpenseChart, 1000);
            });
        </script>

    <div class="cy227-preview-btn" id="cy227PreviewBtn">
        <i class="fas fa-globe"></i>
    </div>
    
    <div class="cy227-modal" id="cy227Modal">
        <div class="cy227-modal-content">
            <span class="cy227-close" id="cy227Close">&times;</span>
            <iframe class="cy227-iframe" src="/preview-cy227"></iframe>
        </div>
    </div>

    <script>
        // cy227.comé¢„è§ˆåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const previewBtn = document.getElementById('cy227PreviewBtn');
            const modal = document.getElementById('cy227Modal');
            const closeBtn = document.getElementById('cy227Close');
            
            previewBtn.addEventListener('click', function() {
                modal.style.display = 'block';
            });
            
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>
</html>
